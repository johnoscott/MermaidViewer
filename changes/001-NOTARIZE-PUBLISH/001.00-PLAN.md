# 001: Sign, Notarize & Publish via GitHub Actions

## Context

MermaidViewer is a macOS Quick Look extension (Swift/SwiftUI, 3 targets: main app, Quick Look extension, Thumbnail extension) with no CI/CD. The goal is to create a GitHub Actions workflow that builds, code-signs with a Developer ID certificate, notarizes with Apple, packages as a DMG, and publishes to GitHub Releases.

## Trigger

- **Tag push:** `v*` pattern (e.g., `v1.0.0`)
- **Manual dispatch:** with a `version` input field

## Workflow Steps

1. **Checkout** code
2. **Install XcodeGen** via Homebrew
3. **Import code signing certificate** — decode base64 Developer ID Application `.p12` from secrets, import into a temporary keychain
4. **Generate Xcode project** — `xcodegen generate`
5. **Build & Archive** — `xcodebuild archive` with Release configuration, overriding signing settings for manual signing with the imported Developer ID cert
6. **Export archive** — `xcodebuild -exportArchive` with `method: developer-id` using a generated ExportOptions.plist
7. **Notarize** — Submit the exported app to Apple's notary service using `xcrun notarytool` with App Store Connect API key credentials, then staple the notarization ticket
8. **Package as DMG** — Use `hdiutil` to create a DMG with the app and a symlink to /Applications (drag-to-install UX)
9. **Create GitHub Release** — Upload the DMG with auto-generated release notes

## Required GitHub Secrets

| Secret | Description |
|--------|-------------|
| `DEVELOPER_ID_CERTIFICATE_P12` | Base64-encoded Developer ID Application certificate (.p12) |
| `DEVELOPER_ID_CERTIFICATE_PASSWORD` | Password for the .p12 file |
| `APPLE_TEAM_ID` | Apple Developer Team ID |
| `NOTARY_API_KEY_ID` | App Store Connect API Key ID |
| `NOTARY_API_KEY_ISSUER_ID` | App Store Connect API Issuer ID |
| `NOTARY_API_KEY_BASE64` | Base64-encoded App Store Connect API private key (.p8) |

## Files to Create

| File | Purpose |
|------|---------|
| `.github/workflows/release.yml` | The full CI/CD workflow |

## Key Design Decisions

- **Manual signing in CI**: The project uses automatic signing locally, but CI overrides with `CODE_SIGN_STYLE=Manual` and `CODE_SIGN_IDENTITY="Developer ID Application"` via xcodebuild build settings.
- **Temporary keychain**: Created at workflow start, destroyed on cleanup to avoid leaking certs.
- **App Store Connect API key for notarization**: Preferred over Apple ID + password since it avoids 2FA issues.
- **DMG packaging**: Uses `hdiutil` to create a standard macOS distribution image with /Applications symlink.
- **Version from tag**: Extracted from tag name (`v1.0.0` → `1.0.0`) and injected into `MARKETING_VERSION`.
- **Runner**: `macos-15` (GitHub-hosted with Xcode 16+).

## Setup Instructions (for README/docs)

### Exporting the Developer ID certificate

```bash
# In Keychain Access, export "Developer ID Application: ..." as .p12
# Then base64 encode it:
base64 -i DeveloperID.p12 | pbcopy
# Paste as DEVELOPER_ID_CERTIFICATE_P12 secret
```

### Creating an App Store Connect API key

1. Go to https://appstoreconnect.apple.com/access/integrations/api
2. Create a new key with "Developer" role
3. Download the .p8 file
4. Note the Key ID and Issuer ID
5. Base64 encode the .p8: `base64 -i AuthKey_XXXXXX.p8 | pbcopy`
6. Store as secrets: `NOTARY_API_KEY_BASE64`, `NOTARY_API_KEY_ID`, `NOTARY_API_KEY_ISSUER_ID`
